From 5fb46f9657b2204e73316eae4b0e1b553b75be63 Mon Sep 17 00:00:00 2001
From: "Peter A. G. Crosthwaite" <peter.crosthwaite@petalogix.com>
Date: Tue, 3 Apr 2012 16:17:30 +1000
Subject: [PATCH 02/26] xilinx_zynq: added sdhci controller

Taken from qemu mailing list:
http://patchwork.ozlabs.org/patch/150328/

Signed-off-by: Peter A. G. Crosthwaite <peter.crosthwaite@petalogix.com>
Integrated-by: Liming Wang <liming.wang@windriver.com>
---
 hw/xilinx_zynq.c |   13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/hw/xilinx_zynq.c b/hw/xilinx_zynq.c
index c55dafb..4c7e939 100644
--- a/hw/xilinx_zynq.c
+++ b/hw/xilinx_zynq.c
@@ -158,6 +158,18 @@ static void zynq_init(QEMUMachineInitArgs *args)
     sysbus_create_varargs("cadence_ttc", 0xF8002000,
             pic[69-IRQ_OFFSET], pic[70-IRQ_OFFSET], pic[71-IRQ_OFFSET], NULL);
 
+    dev = qdev_create(NULL, "sysbus_sdhci");
+    dinfo = drive_get(IF_SD, 0, 0);
+    if (dinfo) {
+        if (qdev_prop_set_drive(dev, "block", dinfo ? dinfo->bdrv : NULL)) {
+            fprintf(stderr, "ZYNQ: ERROR: bad sd data file specified\n");
+        }
+    }
+    qdev_init_nofail(dev);
+    busdev = sysbus_from_qdev(dev);
+    sysbus_mmio_map(busdev, 0, 0xE0100000);
+    sysbus_connect_irq(busdev, 0, pic[56-IRQ_OFFSET]);
+
     for (n = 0; n < nb_nics; n++) {
         nd = &nd_table[n];
         if (n == 0) {
@@ -183,7 +195,6 @@ static QEMUMachine zynq_machine = {
     .init = zynq_init,
     .use_scsi = 1,
     .max_cpus = 1,
-    .no_sdcard = 1
 };
 
 static void zynq_machine_init(void)
-- 
1.7.9.5

